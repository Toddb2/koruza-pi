#!/usr/bin/env python
import RPi.GPIO as GPIO
import time
import json
import nnpy
import select

# Stepper motor pins 
PIN_MOTOR_1 = 14  # IN1
PIN_MOTOR_2 = 15  # IN2
PIN_MOTOR_3 = 17  # IN3
PIN_MOTOR_4 = 18  # IN4

# Stepper motor sequence
STEPPER_SEQUENCE = [
    [1, 0, 0, 0],
    [1, 1, 0, 0],
    [0, 1, 0, 0],
    [0, 1, 1, 0],
    [0, 0, 1, 0],
    [0, 0, 1, 1],
    [0, 0, 0, 1],
    [1, 0, 0, 1],
]

# GPIO setup.
GPIO.setwarnings(False)
GPIO.setmode(GPIO.BCM)
GPIO.setup(PIN_MOTOR_1, GPIO.OUT)
GPIO.setup(PIN_MOTOR_2, GPIO.OUT)
GPIO.setup(PIN_MOTOR_3, GPIO.OUT)
GPIO.setup(PIN_MOTOR_4, GPIO.OUT)

# Establish IPC connection.
ipc = nnpy.Socket(nnpy.AF_SP, nnpy.SUB)
ipc.connect('ipc:///tmp/koruza-publish.ipc')
ipc.setsockopt(nnpy.SUB, nnpy.SUB_SUBSCRIBE, '')

poll = select.poll()
poll.register(ipc.getsockopt(nnpy.SOL_SOCKET, nnpy.RCVFD), select.POLLIN)

# Initialize motor state.
current_step = 0
last_motors_update = None

# Function to set motor pins based on the step sequence.
def set_motor_pins(step):
    GPIO.output(PIN_MOTOR_1, STEPPER_SEQUENCE[step][0])
    GPIO.output(PIN_MOTOR_2, STEPPER_SEQUENCE[step][1])
    GPIO.output(PIN_MOTOR_3, STEPPER_SEQUENCE[step][2])
    GPIO.output(PIN_MOTOR_4, STEPPER_SEQUENCE[step][3])

# Main loop.
while True:
    now = time.time()

    # Check for incoming updates.
    fds = poll.poll(100)
    if fds:
        topic, payload = ipc.recv().split('@', 1)
        data = json.loads(payload)
        if data['type'] == 'motors':
            # Example: Increment or decrement motor steps based on received commands.
            command = data['motor'].get('command')
            if command == 'step_forward':
                current_step = (current_step + 1) % len(STEPPER_SEQUENCE)
                set_motor_pins(current_step)
            elif command == 'step_backward':
                current_step = (current_step - 1) % len(STEPPER_SEQUENCE)
                set_motor_pins(current_step)
            last_motors_update = now

    # Reset motor pins if no updates for a while (watchdog).
    if last_motors_update and now - last_motors_update > 10:
        GPIO.output(PIN_MOTOR_1, 0)
        GPIO.output(PIN_MOTOR_2, 0)
        GPIO.output(PIN_MOTOR_3, 0)
        GPIO.output(PIN_MOTOR_4, 0)
        last_motors_update = None
